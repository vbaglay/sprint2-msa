# ADR: Миграция монолита Hotelio на микросервисную архитектуру

## Status
Proposed

## Context
### Текущее состояние
Монолитное приложение Hotelio с модулями:
- **Бронирования** (booking) - критически важный бизнес-процесс
- **Пользователи** (users) - управление профилями и авторизацией
- **Отели** (hotels) - каталог и управление отелями
- **Промокоды** (promos) - система скидок и акций
- **Отзывы** (reviews) - рейтинги и отзывы

### Ключевые проблемы
1. **Технический долг** - сложность внесения изменений в изолированные модули
2. **Масштабируемость** - невозможно масштабировать отдельные компоненты
3. **Надежность** - ошибка в одном модуле влияет на всю систему
4. **Скорость разработки** - длительные циклы тестирования и развертывания
5. **Технологические ограничения** - единый стек технологий для всех модулей

### Обнаруженные проблемы
- Отсутствие изоляции данных между модулями
- Прямые SQL-запросы между бизнес-контекстами
- Нет четких границ контекстов (Bounded Context)
- Сложность тестирования отдельных компонентов

## Decision
### Целевая архитектура
```
┌─────────────────┐    ┌──────────────────┐    ┌─────────────────┐
│   API Gateway   │────│   Service Mesh   │────│  Microservices  │
│                 │    │   (Istio)        │    │                 │
└─────────────────┘    └──────────────────┘    └─────────────────┘
         │                       │                       │
┌─────────────────┐    ┌──────────────────┐    ┌─────────────────┐
│  Client Apps    │    │  Observability   │    │  Data Storage   │
│                 │    │   (Monitoring)   │    │  (per service)  │
└─────────────────┘    └──────────────────┘    └─────────────────┘
```

### Принципы
1. **Domain-Driven Design** - четкие границы контекстов
2. **Database per Service** - изоляция данных
3. **Event-Driven Architecture** - асинхронная коммуникация
4. **Service Mesh** - управление трафиком и наблюдаемость
5. **CI/CD с Canary Releases** - безопасные развертывания

## Solution Options

### Option 1: Полная переписывание (Rejected)
- **Плюсы**: Чистая архитектура с начала
- **Минусы**: Высокий риск, длительная разработка, большой downtime

### Option 2: Strangler Fig Pattern (Selected)
- **Плюсы**: Постепенная миграция, низкий риск, возможность отката
- **Минусы**: Временная сложность поддержки двух систем

### Option 3: Branch by Abstraction (Considered)
- **Плюсы**: Меньше дублирования кода
- **Минусы**: Сложнее в реализации для изоляции данных

## Выбор стартового модуля: Booking Service

### Обоснование выбора
1. **Бизнес-ценность**: Ядро системы бронирований
2. **Сложность**: Высокая, но хорошо определенные границы
3. **Данные**: Четко отделимые от других контекстов
4. **Трафик**: Высокая нагрузка, требует масштабирования
5. **Риск**: Контролируемый, с fallback на монолит

### Диаграмма миграции Booking Service
```
┌─────────────────────────────────────────────────────────────┐
│                    Current Monolith                         │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐  │
│  │   Users     │  │   Hotels    │  │      Booking        │  │
│  │             │  │             │  │ (to be extracted)   │  │
│  └─────────────┘  └─────────────┘  └─────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
                               │
                               ▼
┌─────────────────────────────────────────────────────────────┐
│                    Transition Phase                        │
│  ┌─────────────┐      ┌─────────────┐      ┌─────────────┐  │
│  │   Monolith  │◄────►│ API Gateway │◄────►│ Booking MS  │  │
│  │             │      │             │      │             │  │
│  └─────────────┘      └─────────────┘      └─────────────┘  │
└─────────────────────────────────────────────────────────────┘
                               │
                               ▼
┌─────────────────────────────────────────────────────────────┐
│                    Target Architecture                      │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │   Users MS  │  │  Hotels MS  │  │  Booking MS │         │
│  │             │  │             │  │             │         │
│  └─────────────┘  └─────────────┘  └─────────────┘         │
└─────────────────────────────────────────────────────────────┘
```

## План миграции по Strangler Fig

### Phase 1: Подготовка (4-6 недель)
1. **Настройка инфраструктуры**
   - Развертывание Kubernetes + Istio
   - Настройка CI/CD пайплайнов
   - Мониторинг и логирование

2. **Выделение Booking Context**
   - Определение границ контекста бронирований
   - Создание отдельной БД для бронирований
   - Реализация регрессионных тестов

### Phase 2: Дублирование функциональности (6-8 недель)
1. **Разработка Booking Microservice**
   - Реализация core-функциональности бронирований
   - Миграция данных в отдельную БД
   - Настройка двусторонней синхронизации

2. **Внедрение API Gateway**
   - Маршрутизация запросов между монолитом и микросервисом
   - Canary routing для тестирования
   - Feature flags для управления трафиком

### Phase 3: Перенаправление трафика (4 недели)
1. **Поэтапное переключение**
   - 10% трафика → микросервис (Canary)
   - 50% трафика → микросервис (A/B testing)
   - 100% трафика → микросервис

2. **Мониторинг и оптимизация**
   - Сравнение метрик производительности
   - Оптимизация на основе реальной нагрузки
   - Резервный план отката

### Phase 4: Стабилизация (2 недели)
1. **Отключение старого кода**
   - Удаление booking модуля из монолита
   - Отключение синхронизации данных
   - Архивация старой БД

### Phase 5: Последующие миграции (по модульно)
1. **Приоритизация следующих модулей**
   - Users → Promos → Hotels → Reviews
2. **Повторение паттерна** для каждого модуля

## Технические детали реализации


### Fallback Mechanism
- Circuit breakers для вызовов между сервисами
- Automatic fallback к монолиту при ошибках
- Мониторинг качества сервиса (SLO)

## Риски и митигация

### Технические риски
1. **Производительность**: Мониторинг и нагрузочное тестирование
2. **Консистентность данных**: Двухфазные коммиты и саги
3. **Сложность отладки**: Распределенная трассировка

### Бизнес-риски
1. **Downtime**: Поэтапный rollout с возможностью отката
2. **Data loss**: Dual-write с верификацией
3. **User experience**: Feature flags для контроля изменений

## Метрики успеха

### Technical Metrics
- Время ответа API < 200ms
- Доступность 99.9%
- Успешность развертываний > 95%

### Business Metrics  
- Скорость разработки новых функций +50%
- Время восстановления при ошибках < 15min
- Стоимость инфраструктуры на транзакцию -30%
